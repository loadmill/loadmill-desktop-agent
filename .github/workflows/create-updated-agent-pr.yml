name: Create a PR with updated @loadmill/agent
on: push

jobs:
  check-package-updates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 14
      - name: Check if installed @loadmill/agent version is indeed outdated
        run: yarn outdated @loadmill/agent
        id: outdated_agent_package
        continue-on-error: true
      - name: Calculate and Set the Should Continue Flag
        if: steps.outdated_agent_package.outcome != 'success'
        run: echo "continue=true" >> $GITHUB_OUTPUT
        id: continuer
      - name: Get Latest @loadmill/agent Version
        if: steps.continuer.outputs.continue == 'true'
        run: echo "agent_latest_version=$(yarn info @loadmill/agent --json | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['version'])")" >> $GITHUB_OUTPUT
        id: get_latest_agent_version
      - name: Show Latest @loadmill/agent Version
        if: steps.continuer.outputs.continue == 'true'
        run: echo ${{ steps.get_latest_agent_version.outputs.agent_latest_version }}
      - name: Fail Fast If PR Already Exists
        if: steps.continuer.outputs.continue == 'true'
        run: git show-ref refs/heads/agent-version-${{ steps.get_latest_agent_version.outputs.agent_latest_version }} && fail-fast
        id: already_exists
      - name: Install New @loadmill/agent Version
        if: steps.continuer.outputs.continue == 'true'
        run: yarn add @loadmill/agent
      - name: Bump This Repo's (patch) Version
        if: steps.continuer.outputs.continue == 'true'
        run: yarn version
      - name: Create Pull Request
        if: steps.continuer.outputs.continue == 'true'
        uses: peter-evans/create-pull-request@v4
        with:
          commit-message: 👆🕵️ Upgrade to agent version ${{ steps.get_latest_agent_version.outputs.agent_latest_version }}
          title: 👆🕵️ Upgrade to agent version ${{ steps.get_latest_agent_version.outputs.agent_latest_version }}
          body: This PR is autogenerated when a new @loadmill/agent version has been released.
          branch: agent-version-${{ steps.get_latest_agent_version.outputs.agent_latest_version }}
          reviewers: yigaldviri, Gilad-Gur-Andelman
