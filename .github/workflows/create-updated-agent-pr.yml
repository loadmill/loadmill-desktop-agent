name: Create a PR with updated @loadmill/agent
on: push

jobs:
  check-package-updates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 14
      - name: Check If Installed @loadmill/agent Version Is Outdated
        run: yarn outdated @loadmill/agent
        id: outdated_agent_package
        continue-on-error: true
      - name: Fail Fast When Agent Is Up To Date
        if: steps.outdated_agent_package.outcome == 'success'
        run: fail-fast
        id: fail_on_up_to_date
      - name: Get Latest @loadmill/agent Version
        run: echo "agent_latest_version=$(yarn info @loadmill/agent --json | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['version'])")" >> $GITHUB_OUTPUT
        id: get_latest_agent_version
      - name: Show Latest @loadmill/agent Version
        run: echo ${{ steps.get_latest_agent_version.outputs.agent_latest_version }}
      - name: Fail Fast When PR Already Exists
        run: git show-ref refs/heads/agent-version-${{ steps.get_latest_agent_version.outputs.agent_latest_version }}
        id: already_exists
        continue-on-error: true
      - name: Fail Fast When PR Already Exists
        if: steps.already_exists.outcome == 'success'
        run: fail-fast
        id: fail_on_pr_aready_exists
      - name: Install New @loadmill/agent Version
        run: yarn add @loadmill/agent
      - name: Increment This Repo's Patch Version
        run: yarn version --patch --no-git-tag-version
      - name: Create Pull Request
        if: steps.continuer.outputs.continue == 'true'
        uses: peter-evans/create-pull-request@v4
        with:
          commit-message: 👆🕵️ Upgrade to agent version ${{ steps.get_latest_agent_version.outputs.agent_latest_version }}
          title: 👆🕵️ Upgrade to agent version ${{ steps.get_latest_agent_version.outputs.agent_latest_version }}
          body: This PR is autogenerated when a new @loadmill/agent version has been released.
          branch: agent-version-${{ steps.get_latest_agent_version.outputs.agent_latest_version }}
          reviewers: yigaldviri, Gilad-Gur-Andelman
